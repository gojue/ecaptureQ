# ecaptureQ

ä¸€ä¸ªä½¿ç”¨ Tauri å’Œ React æ„å»ºçš„è·¨å¹³å°ç½‘ç»œæŠ“åŒ…ä¸åˆ†æå·¥å…·ã€‚

## ğŸ›ï¸ é¡¹ç›®æ¶æ„ (Architecture)

`ecaptureQ` é‡‡ç”¨ **Tauri** æ¡†æ¶ï¼Œå°†é«˜æ€§èƒ½çš„ **Rust** åç«¯ä¸ç°ä»£åŒ–çš„ **React** å‰ç«¯ç›¸ç»“åˆã€‚æ ¸å¿ƒè®¾è®¡æ€æƒ³æ˜¯ï¼šç”± Rust è´Ÿè´£ç¹é‡çš„æ•°æ®æ•è·å’Œå¤„ç†ä»»åŠ¡ï¼Œå¹¶å°†ç»“æœé«˜æ•ˆåœ°ä¼ é€’ç»™ React UI è¿›è¡Œå±•ç¤ºã€‚

-----

### 1\. åç«¯æ¶æ„ (Rust)

åç«¯æ˜¯æ•´ä¸ªåº”ç”¨çš„å¤§è„‘ï¼Œè´Ÿè´£å¯åŠ¨æŠ“åŒ…ã€å¤„ç†æ•°æ®å’Œå“åº”å‰ç«¯è¯·æ±‚ã€‚å®ƒä¸»è¦ç”±ä»¥ä¸‹å‡ ä¸ªæ¨¡å—æ„æˆï¼š

#### **æ ¸å¿ƒæœåŠ¡ (`src-tauri/src/services`)**

è¿™äº›æ˜¯ç‹¬ç«‹çš„åå°ä»»åŠ¡ï¼Œè´Ÿè´£ä¸å¤–éƒ¨è¿›ç¨‹å’Œæ•°æ®æºäº¤äº’ã€‚

  * **`CaptureManager`**:

      * **èŒè´£**: ç®¡ç†æ ¸å¿ƒæŠ“åŒ…ç¨‹åºï¼ˆåœ¨å¼€å‘é˜¶æ®µä¸º `mock_ws.go` ç¼–è¯‘çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼‰çš„ç”Ÿå‘½å‘¨æœŸã€‚
      * **æµç¨‹**:
        1.  ä»åº”ç”¨å†…é‡Šæ”¾äºŒè¿›åˆ¶æ–‡ä»¶åˆ°åº”ç”¨æ•°æ®ç›®å½•ã€‚
        2.  èµ‹äºˆå…¶å¯æ‰§è¡Œæƒé™ (`0o755`)ã€‚
        3.  é€šè¿‡ `su` æƒé™å¯åŠ¨å­è¿›ç¨‹ã€‚
        4.  ç›‘å¬ `shutdown` ä¿¡å·ï¼Œé€šè¿‡å‘é€ `SIGINT` æ¥ä¼˜é›…åœ°ç»ˆæ­¢å­è¿›ç¨‹ã€‚

  * **`WebsocketService`**:

      * **èŒè´£**: è¿æ¥ç”±æ ¸å¿ƒæŠ“åŒ…ç¨‹åºæä¾›çš„ WebSocket æœåŠ¡ï¼Œæ¥æ”¶å®æ—¶æ•°æ®åŒ…ã€‚
      * **æµç¨‹**:
        1.  è¿æ¥åˆ° `ws://127.0.0.1:18088/ws`ã€‚
        2.  å¼‚æ­¥æ¥æ”¶ JSON æ ¼å¼çš„æ•°æ®åŒ…ã€‚
        3.  ä¸ºäº†æ€§èƒ½ï¼Œå®ƒä¼šå°†æ•°æ®åŒ…ç¼“å­˜èµ·æ¥ï¼Œå½“è¾¾åˆ°ä¸€å®šæ•°é‡ (`BATCH_SIZE`) æˆ–è¶…æ—¶ (`FLUSH_TIMEOUT`) åï¼Œæ‰¹é‡å‘é€ç»™ `DataFrameActor` å¤„ç†ã€‚

#### **æ•°æ®æ ¸å¿ƒ (`src-tauri/src/core`)**

è¿™æ˜¯æ•°æ®å¤„ç†å’Œå­˜å‚¨çš„ä¸­å¿ƒï¼Œé‡‡ç”¨äº† **Actor æ¨¡å‹** æ¥ä¿è¯é«˜æ€§èƒ½å’Œçº¿ç¨‹å®‰å…¨ã€‚

  * **`DataFrameActor`**:
      * **èŒè´£**: ä½œä¸ºä¸€ä¸ªç‹¬ç«‹çš„å¼‚æ­¥ä»»åŠ¡ï¼Œä¸“é—¨è´Ÿè´£ç®¡ç†ä¸€ä¸ª **Polars `DataFrame`**ã€‚`DataFrame` æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„å†…å­˜æ•°æ®è¡¨ã€‚
      * **è®¾è®¡**: ä½¿ç”¨ Actor æ¨¡å‹ï¼ˆé€šè¿‡ `tokio::mpsc` channelï¼‰å¯ä»¥é¿å…å¤šçº¿ç¨‹ç›´æ¥è®¿é—® `DataFrame` å¸¦æ¥çš„æ•°æ®ç«äº‰å’Œé”å¼€é”€ã€‚æ‰€æœ‰å¯¹ `DataFrame` çš„è¯»å†™æ“ä½œéƒ½é€šè¿‡æ¶ˆæ¯ä¼ é€’è¿›è¡Œã€‚
      * **æ¶ˆæ¯ç±»å‹ (`ActorMessage`)**:
          * `UpdateBatch`: ä» `WebsocketService` æ¥æ”¶æ‰¹é‡æ•°æ®åŒ…ï¼Œå¹¶å°†å…¶è¿½åŠ åˆ° `DataFrame` ä¸­ã€‚
          * `QuerySql`: æ¥æ”¶æ¥è‡ªå‰ç«¯çš„ SQL æŸ¥è¯¢è¯·æ±‚ï¼Œä½¿ç”¨ Polars å†…ç½®çš„ SQL å¼•æ“æŸ¥è¯¢ `DataFrame` å¹¶è¿”å›ç»“æœã€‚

#### **Tauri æ¡¥æ¥å±‚ (`src-tauri/tauri_bridge`)**

è¿™æ˜¯ Rust åç«¯ä¸ JavaScript å‰ç«¯çš„æ²Ÿé€šæ¡¥æ¢ã€‚

  * **`commands.rs`**:
      * å®šä¹‰äº†æ‰€æœ‰æš´éœ²ç»™å‰ç«¯çš„æ¥å£ï¼Œä¾‹å¦‚ `start_capture`ã€`stop_capture`ã€`get_all_data`ã€`get_incremental_data`ã€‚
      * è¿™äº›å‘½ä»¤é€šè¿‡ Tauri çš„ `invoke` æœºåˆ¶è¢«å‰ç«¯è°ƒç”¨ã€‚
  * **`state.rs`**:
      * å®šä¹‰äº†å…¨å±€å…±äº«çš„åº”ç”¨çŠ¶æ€ `AppState`ï¼Œç”± Tauri ç®¡ç†ã€‚
      * `AppState` æŒæœ‰ `DataFrameActorHandle` (ç”¨äºä¸ Actor é€šä¿¡) å’Œåå°ä»»åŠ¡çš„å¥æŸ„ï¼Œæ–¹ä¾¿åœ¨ä¸åŒå‘½ä»¤ä¹‹é—´å…±äº«çŠ¶æ€å’Œæ§åˆ¶ä»»åŠ¡ã€‚

-----

### 2\. å‰ç«¯æ¶æ„ (React)

å‰ç«¯ä½¿ç”¨ `React`ã€`TypeScript` å’Œ `Tailwind CSS` æ„å»ºï¼Œè´Ÿè´£ç”¨æˆ·äº¤äº’å’Œæ•°æ®å¯è§†åŒ–ã€‚

#### **UI ç»„ä»¶ (`src/components`)**

  * **`NewPacketList`**: åˆ—è¡¨æ˜¯åº”ç”¨çš„æ ¸å¿ƒã€‚ä¸ºäº†å¤„ç†å¤§é‡æ•°æ®åŒ…è€Œä¸å¡é¡¿ï¼Œè¿™é‡Œä½¿ç”¨äº† `react-window` åº“å®ç°äº†**è™šæ‹Ÿåˆ—è¡¨**ï¼Œåªæ¸²æŸ“è§†å£å†…å¯è§çš„åˆ—è¡¨é¡¹ã€‚
  * **`NewPacketCard`**: å•ä¸ªæ•°æ®åŒ…çš„å¡ç‰‡å±•ç¤ºã€‚
  * **`Controls`**: åŒ…å«â€œå¼€å§‹/åœæ­¢/æ¸…ç©ºâ€ç­‰åŠŸèƒ½çš„æ§åˆ¶æ ã€‚
  * **`DetailModal`**: ç‚¹å‡»æ•°æ®åŒ…åå¼¹å‡ºçš„è¯¦æƒ…æ¨¡æ€æ¡†ï¼Œå±•ç¤ºè§£ç åçš„ `payload` ç­‰ä¿¡æ¯ã€‚

#### **çŠ¶æ€ç®¡ç† (`src/hooks/useAppState.ts`)**

  * æ•´ä¸ªåº”ç”¨çš„å®¢æˆ·ç«¯çŠ¶æ€ç”±ä¸€ä¸ªè‡ªå®šä¹‰ Hook `useAppState` é›†ä¸­ç®¡ç†ï¼Œè¿™ç®€åŒ–äº†çŠ¶æ€é€»è¾‘ã€‚
  * å®ƒè´Ÿè´£ç®¡ç† `isCapturing` (æ˜¯å¦åœ¨æŠ“åŒ…)ã€`packets` (æ•°æ®åŒ…åˆ—è¡¨) ç­‰æ ¸å¿ƒçŠ¶æ€ã€‚
  * **æ•°æ®åŒæ­¥**: å½“ç”¨æˆ·ç‚¹å‡» "Start Capture" åï¼Œ`useAppState` ä¼šé¦–å…ˆè°ƒç”¨ `getAllData` åŠ è½½ä¸€æ¬¡å…¨é‡æ•°æ®ï¼Œç„¶å**å¯åŠ¨ä¸€ä¸ªå®šæ—¶å™¨ (`setInterval`)ï¼Œå‘¨æœŸæ€§åœ°è°ƒç”¨ `getIncrementalData` æ¥æ‹‰å–å¢é‡æ•°æ®**ï¼Œå®ç°è¿‘ä¹å®æ—¶çš„æ•°æ®æ›´æ–°ã€‚

#### **API æœåŠ¡ (`src/services/apiService.ts`)**

  * è¿™æ˜¯ä¸€ä¸ªå°è£…å±‚ï¼Œå°†å¯¹ Tauri åç«¯å‘½ä»¤çš„è°ƒç”¨ (`invoke`) åŒ…è£…æˆæ˜“äºä½¿ç”¨çš„å¼‚æ­¥å‡½æ•° (`startCapture`, `stopCapture` ç­‰)ã€‚è¿™ä½¿å¾—ä¸šåŠ¡é€»è¾‘ä¸åº•å±‚çš„ Tauri API è§£è€¦ã€‚

-----

### 3\. å®Œæ•´æ•°æ®æµ (ä»æŠ“åŒ…åˆ°æ˜¾ç¤º)

1.  **å¯åŠ¨**: ç”¨æˆ·ç‚¹å‡» "Start" æŒ‰é’®ã€‚
2.  **å‰ç«¯**: `useAppState` -\> `apiService.startCapture()` -\> `invoke('start_capture')`ã€‚
3.  **åç«¯**: `start_capture` å‘½ä»¤è¢«è§¦å‘ã€‚
4.  **æœåŠ¡å¯åŠ¨**: åç«¯åˆ›å»ºå¹¶å¯åŠ¨ `CaptureManager` å’Œ `WebsocketService` ä¸¤ä¸ªå¼‚æ­¥ä»»åŠ¡ã€‚
5.  **æ¨¡æ‹Ÿå™¨è¿è¡Œ**: `CaptureManager` å¯åŠ¨ `mock_ws.go` ç¼–è¯‘çš„äºŒè¿›åˆ¶æ–‡ä»¶ã€‚è¯¥ç¨‹åºå¼€å§‹é€šè¿‡å…¶å†…ç½®çš„ WebSocket æœåŠ¡å™¨å¹¿æ’­æ¨¡æ‹Ÿçš„æ•°æ®åŒ…ã€‚
6.  **æ•°æ®æ¥æ”¶**: `WebsocketService` è¿æ¥åˆ°æ¨¡æ‹Ÿå™¨çš„ WebSocketï¼Œå¼€å§‹æ¥æ”¶ JSON æ ¼å¼çš„æ•°æ®åŒ…ã€‚
7.  **æ•°æ®å…¥åº“**: `WebsocketService` å°†æ•°æ®åŒ…æ‰¹é‡å‘é€ç»™ `DataFrameActor`ã€‚
8.  **æ•°æ®å¤„ç†**: `DataFrameActor` å°†è¿™æ‰¹æ•°æ®é«˜æ•ˆåœ°å†™å…¥ Polars `DataFrame`ã€‚
9.  **å‰ç«¯è½®è¯¢**: ä¸æ­¤åŒæ—¶ï¼Œå‰ç«¯çš„ `useAppState` Hook ä¸­çš„å®šæ—¶å™¨ä¸æ–­è°ƒç”¨ `getIncrementalData` å‘½ä»¤ã€‚
10. **æ•°æ®æŸ¥è¯¢**: è¯¥å‘½ä»¤å‘ `DataFrameActor` å‘é€ä¸€ä¸ª SQL æŸ¥è¯¢ï¼ˆå¦‚ `SELECT * FROM packets OFFSET ...`ï¼‰ï¼Œåªè·å–æ–°åˆ°è¾¾çš„æ•°æ®ã€‚
11. **UI æ›´æ–°**: æ–°æ•°æ®è¿”å›åˆ°å‰ç«¯ï¼Œ`useAppState` æ›´æ–° `packets` çŠ¶æ€ï¼Œ`React` è‡ªåŠ¨æ¸²æŸ“å‡ºæ–°çš„æ•°æ®åŒ…å¡ç‰‡ã€‚
12. **åœæ­¢**: ç”¨æˆ·ç‚¹å‡» "Stop"ï¼Œåç«¯å‘é€ `shutdown` ä¿¡å·ï¼Œæ‰€æœ‰æœåŠ¡å’Œæ¨¡æ‹Ÿå™¨è¿›ç¨‹ä¼˜é›…é€€å‡ºï¼Œå‰ç«¯è½®è¯¢åœæ­¢ã€‚

-----

## ğŸš€ å¼€å‘ä¸ç¼–è¯‘ (Development & Build)

### ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®è¿›è¡Œå¼€å‘

ä¸ºäº†æ–¹ä¾¿å‰ç«¯å¼€å‘å’Œåç«¯æ•°æ®å¤„ç†é€»è¾‘çš„æµ‹è¯•ï¼ˆæ— éœ€ä¾èµ–çœŸå®çš„ `eCapture` ç¯å¢ƒï¼‰ï¼Œé¡¹ç›®æä¾›äº†ä¸€ä¸ª Go è¯­è¨€ç¼–å†™çš„ WebSocket æ¨¡æ‹Ÿæ•°æ®æœåŠ¡å™¨ã€‚

  * **æ–‡ä»¶**: `scripts/mock_ws.go`
  * **åŠŸèƒ½**:
      * å¯åŠ¨ä¸€ä¸ªå’Œ `eCapture` æ¥å£å®Œå…¨ç›¸åŒçš„ WebSocket æœåŠ¡å™¨ (`ws://127.0.0.1:18088/ws`)ã€‚
      * æ¨¡æ‹ŸçœŸå®ç½‘ç»œç¯å¢ƒä¸­çš„â€œçªå‘â€å’Œâ€œå¹³é™â€é˜¶æ®µï¼Œä»¥ä¸è§„åˆ™çš„æ¨¡å¼æŒç»­å‘é€ç¬¦åˆ `PacketData` ç»“æ„çš„æ•°æ®ã€‚
      * è¿™ä½¿å¾—å¼€å‘è€…å¯ä»¥åœ¨ä»»ä½•æœºå™¨ä¸Šè¿›è¡Œç«¯åˆ°ç«¯çš„åº”ç”¨åŠŸèƒ½æµ‹è¯•ã€‚

### ç¼–è¯‘æµç¨‹ (Android)

ç¼–è¯‘æµç¨‹ç°åœ¨åŒ…å«å°† Go æ¨¡æ‹Ÿå™¨äº¤å‰ç¼–è¯‘ä¸º Android äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå¹¶å°†å…¶æ‰“åŒ…åˆ°æœ€ç»ˆçš„ APK ä¸­ã€‚

#### **å…ˆå†³æ¡ä»¶**

  * **Go** ç¼–è¯‘å™¨ (\>= 1.18)
  * **Rust** å·¥å…·é“¾ (rustc, cargo)
  * **pnpm** åŒ…ç®¡ç†å™¨
  * **Android SDK å’Œ NDK** (å¯é€šè¿‡ Android Studio å®‰è£…)
  * é…ç½®å¥½ `ANDROID_HOME` å’Œ `NDK_HOME` ç¯å¢ƒå˜é‡

##### Android  è¯ä¹¦ç­¾å
ä¸ºäº†åœ¨ Android ä¸Šå‘å¸ƒåº”ç”¨ï¼Œä½ éœ€è¦ä¸€ä¸ªç­¾åè¯ä¹¦ã€‚å¯ä»¥ä½¿ç”¨ `keytool` å‘½ä»¤ç”Ÿæˆä¸€ä¸ªæ–°çš„å¯†é’¥åº“æ–‡ä»¶ã€‚
```shell
keytool -genkey -v -keystore ~/upload-keystore.jks -keyalg RSA -keysize 2048 -validity 10000 -alias upload
```

å‚è€ƒï¼šhttps://v2.tauri.app/zh-cn/distribute/sign/android/
#### **ç¼–è¯‘æ­¥éª¤**

1.  **ç¼–è¯‘ Go æ¨¡æ‹ŸæœåŠ¡å™¨**:
    æ‰“å¼€ç»ˆç«¯ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œå°† Go æºç äº¤å‰ç¼–è¯‘ä¸º Android ARM64 æ¶æ„çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå¹¶æ”¾ç½®åˆ° `src-tauri/binaries` ç›®å½•ä¸‹ã€‚

    ```bash
    cd ./scripts
    CGO_ENABLED=0 GOOS=android GOARCH=arm64 go build -o ./../src-tauri/binaries/android_test-aarch64-linux-android ./scripts/mock_ws.go
    ```

      * `GOOS=android GOARCH=arm64`: æŒ‡å®šç›®æ ‡å¹³å°ä¸º Android ARM64ã€‚
      * `CGO_ENABLED=0`: ç”Ÿæˆé™æ€é“¾æ¥çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œä¸ä¾èµ– C åº“ã€‚
      * `-o ...`: æŒ‡å®šè¾“å‡ºè·¯å¾„å’Œæ–‡ä»¶åï¼Œè¿™ä¸ªè·¯å¾„å’Œæ–‡ä»¶ååœ¨ Rust ä»£ç  (`src-tauri/src/services/capture.rs`) ä¸­è¢«ç¡¬ç¼–ç ä½¿ç”¨ã€‚

2.  **å®‰è£…å‰ç«¯ä¾èµ–**:

    ```bash
    pnpm install
    ```

3.  **åˆå§‹åŒ– Android é¡¹ç›® (é¦–æ¬¡è¿è¡Œæ—¶éœ€è¦)**:

    ```bash
    pnpm tauri android init
    ```

4.  **æ„å»ºæœ€ç»ˆçš„ Android åº”ç”¨**:
    è¿™ä¸ªå‘½ä»¤ä¼šæŠŠ Tauri çš„ Rust æ ¸å¿ƒã€å‰ç«¯ä»£ç å’Œä½ åœ¨ç¬¬ä¸€æ­¥ä¸­ç¼–è¯‘çš„ Go äºŒè¿›åˆ¶æ–‡ä»¶ä¸€èµ·æ‰“åŒ…æˆä¸€ä¸ª APKã€‚

    ```bash
    pnpm tauri android build --target aarch64
    ```

-----

## ğŸ“ ç›®å½•ç»“æ„

```
.
â”œâ”€â”€ public/                  # é™æ€èµ„æº
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ log.sh               # ç”¨äºæŸ¥çœ‹ Android logcat çš„è¾…åŠ©è„šæœ¬
â”‚   â””â”€â”€ mock_ws.go           # Go è¯­è¨€ç¼–å†™çš„ WebSocket æ¨¡æ‹ŸæœåŠ¡å™¨
â”œâ”€â”€ src/                     # å‰ç«¯ React æºç 
â”‚   â”œâ”€â”€ components/          # React ç»„ä»¶
â”‚   â”œâ”€â”€ hooks/               # è‡ªå®šä¹‰ Hooks (å¦‚ useAppState)
â”‚   â”œâ”€â”€ services/            # å‰ç«¯æœåŠ¡ (å¦‚ apiService)
â”‚   â”œâ”€â”€ types/               # TypeScript ç±»å‹å®šä¹‰
â”‚   â””â”€â”€ App.tsx              # ä¸»åº”ç”¨ç»„ä»¶
â”œâ”€â”€ src-tauri/               # åç«¯ Rust æºç 
â”‚   â”œâ”€â”€ binaries/            # åµŒå…¥çš„äºŒè¿›åˆ¶æ–‡ä»¶ (ç”± mock_ws.go ç¼–è¯‘è€Œæ¥)
â”‚   â”œâ”€â”€ capabilities/        # Tauri æƒé™é…ç½®
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ core/            # æ ¸å¿ƒæ•°æ®å¤„ç† (Actor, Polars)
â”‚   â”‚   â”œâ”€â”€ services/        # åå°æœåŠ¡ (Capture, WebSocket)
â”‚   â”‚   â””â”€â”€ tauri_bridge/    # ä¸å‰ç«¯äº¤äº’çš„å‘½ä»¤å’ŒçŠ¶æ€
â”‚   â”‚   â””â”€â”€ lib.rs           # Rust lib çš„ä¸»å…¥å£
â”‚   â”œâ”€â”€ Cargo.toml           # Rust ä¾èµ–é…ç½®
â”‚   â””â”€â”€ tauri.conf.json      # Tauri åº”ç”¨é…ç½®
â””â”€â”€ package.json             # å‰ç«¯é¡¹ç›®å’Œè„šæœ¬é…ç½®
```